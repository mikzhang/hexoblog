



## 1. 并发编程基础概念

```
并发——在操作系统中，是指一个时间段中有几个程序都处于已启动运行到运行完毕之间，且这几个程序都是在同一个处理机上运行，但任一个时刻点上只有一个程序在处理机上运行——源自百度百科
```

在并发编程中，我们需要处理两个关键问题：线程之间如何通信和线程之间如何同步，后续篇章将围绕这两个问题进行介绍。

- 线程通信：是指线程之间以何种机制来交换信息，在命令式编程中，线程之间的通信机制有两种：共享内存和消息传递。
- 线程同步：是指程序用于控制不同线程之间操作发生相对顺序的机制。在Java中，可以通过volatile，synchronized, 锁等方式实现同步。

本文主要介绍java的通信机制，刚介绍常见通信机制主要包括以下两种方式：

- 共享内存：线程之间共享程序的公共状态，线程之间通过写-读内存中的公共状态来隐式进行通信。
- 消息传递：线程之间没有公共状态，线程之间必须通过明确的发送消息来显式进行通信。

```
Java的并发采用的是共享内存模型，Java线程之间的通信总是隐式进行，整个通信过程对程序员完全透明。在java中，所有实例域、静态域和数组元素存储在堆内存中，堆内存在线程之间共享。
```

Java线程之间的通信由Java内存模型（本文简称为JMM）控制，JMM决定一个线程对共享变量的写入何时对另一个线程可见。

## 2. JMM内存模型

JMM（Java Memory Model）是JVM规范中定义的一种Java内存模型，它的目的是屏蔽掉各种硬件和操作系统的内存访问差异，以实现让Java程序在各种平台上到能达到一致的内存访问效果。
Java内存模型的主要定义程序中各个变量的访问规则，即在虚拟机中将变量存储到内存和从内存中取出变量这样底层细节。首先简单说明几个常用名称定义：


- 变量：这里指包括了实例字段、静态字段和构成数组对象的元素，但是不包括局部变量与方法参数，后者是线程私有的，不会被共享。
- 主内存：在java中，实例域、静态域和数组元素是线程之间共享的数据，它们存储在主内存中。
- _工作内存：每条线程都有自己的工作内存，线程的工作内存中保存了该线程使用到的变量到主内存副本拷贝，线程对变量的所有操作（读取、赋值）都必须在工作内存中进行，而不能直接读写主内存中的变量。

![WX20190429-181907@2x.png](WX20190429-181907@2x.png)

线程、主内存和工作内存的交互关系如上图所示，和CPU-缓存-内存很类似。
不同线程之间无法直接访问对方工作内存中的变量，线程间变量值的传递均需要在主内存来完成。
最后注意，为了获得较好的执行性能，Java内存模型并没有限制执行引擎使用处理器的寄存器或者高速缓存来提升指令执行速度，也没有限制编译器对指令进行重排序。也就是说，在java内存模型中，也会存在缓存一致性问题和指令重排序的问题。

## 3. 内存间交互操作
关于主内存与工作内存之间的具体交互协议，即一个变量如何从主内存拷贝到工作内存、如何从工作内存同步到主内存之间的实现细节，Java内存模型定义了以下八种操作来完成：

- lock（锁定）：作用于主内存的变量，把一个变量标识为一条线程独占状态。
- unlock（解锁）：作用于主内存变量，把一个处于锁定状态的变量释放出来，释放后的变量才可以被其他线程锁定。
- read（读取）：作用于主内存变量，把一个变量值从主内存传输到线程的工作内存中，以便随后的load动作使用
- load（载入）：作用于工作内存的变量，它把read操作从主内存中得到的变量值放入工作内存的变量副本中。
- use（使用）：作用于工作内存的变量，把工作内存中的一个变量值传递给执行引擎，每当虚拟机遇到一个需要使用变量的值的字节码指令时将会执行这个操作。
- assign（赋值）：作用于工作内存的变量，它把一个从执行引擎接收到的值赋值给工作内存的变量，每当虚拟机遇到一个给变量赋值的字节码指令时执行这个操作。
- store（存储）：作用于工作内存的变量，把工作内存中的一个变量的值传送到主内存中，以便随后的write的操作。
- write（写入）：作用于主内存的变量，它把store操作从工作内存中一个变量的值传送到主内存的变量中。

所以变量读写包含以下几个步骤：

1 变量从主内存复制到工作内存——顺序执行read和load操作
2 变量从工作内存同步到主内存——顺序执行store和write操作

注意，Java内存模型只要求上述操作必须按顺序执行，而没有保证必须是连续执行。也就是read和load之间，store和write之间是可以插入其他指令的。
除了定义以上8中原子操作，Java内存模型还规定了上述8种基本操作在执行时必须满足一定的操作规则，例如如不允许read和load单独出现（即不允许一个变量从主内存中读取但工作内存不接受），不允许store和write单独出现（即不允许从工作内存中发起了回写单主内存不接受），这里不一一列举，详细网上搜索即可。


ref:
https://www.jianshu.com/p/b1f7dce224f7
